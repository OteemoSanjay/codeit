#!/bin/bash

# This script lists all SQS queues and prints the approximate message count for each

# Ensure that AWS CLI is installed and configured

AWK=$(command -v awk)
DATE=$(command -v date)
ECHO=$(command -v echo)
FIND=$(command -v find)
GREP=$(command -v grep)
MKDIR=$(command -v mkdir)
MKTEMP=$(command -v mktemp)
OPENSSL=$(command -v openssl)
PRINTF=$(command -v printf)
RM=$(command -v rm)
SED=$(command -v sed)
TEE=$(command -v tee)
TOUCH=$(command -v touch)
UNAME=$(command -v uname)

# Check if aws cli is installed
if ! command -v aws &> /dev/null; then
    echo "AWS CLI not found. Please install AWS CLI first."
    exit 1
fi


# Retrieve all SQS queue URLs
queue_urls=$(aws sqs list-queues --query 'QueueUrls[*]' --output text)

echo "Fetching SQS queue depths..."
echo "Queue URL, Approximate Number of Messages"

# Iterate over each queue URL and fetch the approximate message count
for queue_url in $queue_urls; do
  # Get the approximate number of messages
  message_count=$(aws sqs get-queue-attributes --queue-url $queue_url --attribute-names ApproximateNumberOfMessages --query 'Attributes.ApproximateNumberOfMessages' --output text)
  
  # Print the queue URL and its message count
  echo "$queue_url, $message_count"
done